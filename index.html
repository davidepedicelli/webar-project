<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
</head>

<body>
  <a-scene mindar-image="imageTargetSrc: ./targets.mind;" color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false" mindar-image="warmupTolerance: 1">

    <a-assets>
      <a-asset-item id="avatarModelA" src="./models/characterC.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity id="marker" mindar-image-target="targetIndex: 0">

      <!-- Personaggio A -->
      <a-entity id="modelAWrapper" position="0 0 0">
        <!-- 👇 niente “>” alla fine e aggiungi un id per selezionarlo -->
        <a-gltf-model id="avatarA" src="#avatarModelA" rotation="90 0 0" scale="0.4 0.4 0.4"
          animation-mixer="clip: Walking; loop: repeat"></a-gltf-model>
        <a-entity id="dialogA" position="0 0 1" rotation="90" look-at="#camera">
          <a-text id="text3D" value="" style="border: 0.2em;" color="#fff" width="1" align="center" shader="msdf"
            color="#ffffff" material="emissive: #ffffaa; emissiveIntensity: 0.8">
          </a-text>
        </a-entity>
        <a-entity id="cocktails" position="0 -0.6 1" rotation="90" look-at="#camera">
          <!-- i <a-text> verranno creati via JS -->
        </a-entity>
      </a-entity>

      <!-- Luci -->
      <a-entity light="type: directional; color: #fff; intensity: 1" position="0 1 1"></a-entity>
      <a-entity light="type: ambient; color: #fff; intensity: 0.5"></a-entity>

    </a-entity>
    <div id="cocktailButtons" style="display:none;">
      <button class="cocktail-btn" data-name="Mojito">Mojito</button>
      <button class="cocktail-btn" data-name="Negroni">Negroni</button>
      <button class="cocktail-btn" data-name="Pina Colada">Pina Colada</button>
      <button class="cocktail-btn" data-name="Margarita">Margarita</button>
    </div>
  </a-scene>


  <button id="nextBtn" class="avanti-btn" style="
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 999;
  padding: 10px 20px;
  font-size: 18px;
">Avanti</button>


  <script>
    const wrapper = document.querySelector('#modelAWrapper');
    const avatar = document.querySelector('#avatarA');
    const textEl = document.querySelector('#text3D');
    const buttonsDiv = document.getElementById('cocktailButtons');

    let moving = false;
    let speed = 0.001;

    function typeWriter(text, speed = 80) {
      return new Promise(resolve => {
        let index = 0;
        textEl.setAttribute('value', '');
        function step() {
          if (index < text.length) {
            textEl.setAttribute('value', textEl.getAttribute('value') + text[index]);
            index++;
            setTimeout(step, speed);
          } else {
            resolve();
          }
        }
        step();
      });
    }

    function moveForward() {
      if (moving) {
        let pos = wrapper.getAttribute('position');
        pos.z -= speed;
        wrapper.setAttribute('position', pos);
        requestAnimationFrame(moveForward);
      }
    }

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    // mostra/nasconde lista cocktail
    function showCocktails() {
      buttonsDiv.style.display = 'flex';
    }
    function hideCocktails() {
      buttonsDiv.style.display = 'none';
    }

    // sequenza animazioni UNA VOLTA
    async function playSequence() {
      // reset
      wrapper.setAttribute('position', { x: 0, y: 0, z: 0 });
      textEl.setAttribute('value', '');
      hideCocktails();

      // Step 1: Walking
      moving = true;
      avatar.setAttribute('animation-mixer', 'clip: Walking; loop: repeat');
      moveForward();
      await sleep(3000);

      // Step 2: Waving
      moving = false;
      avatar.setAttribute('animation-mixer', 'clip: Wawing; loop: once');
      await typeWriter("Ciaooo, benvenuto!!!", 100);
      await sleep(1000);

      // Step 3: Talking
      avatar.setAttribute('animation-mixer', 'clip: Talking; loop: once');
      await typeWriter("Seguimi per vedere i nostri cocktail");
      await sleep(1000);

      // Step 4: Pointing
      avatar.setAttribute('animation-mixer', 'clip: Pointing; loop: once');
      await typeWriter("Scegli il tuo cocktail!!", 50);
      await sleep(1000);


      // ora fermo e mostro i bottoni
      showCocktails();

      avatar.setAttribute('animation-mixer', 'clip: Dance; loop: repeat');
      await sleep(1000);
    }

    // click sui bottoni cocktail
    document.querySelectorAll('.cocktail-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.dataset.name;
        console.log('Hai scelto', name);
        // nascondi lista e riparti
        hideCocktails();
        playSequence();
      });
    });

    // avvio la prima volta
    playSequence();
  </script>




  <style>
    #cocktailButtons {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      gap: 22px;
      z-index: 9999;
      width: 220px;
    }

    .cocktail-btn {
      padding: 14px 20px;
      font-size: 18px;
      font-family: 'Arial', sans-serif;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, #ffcc33, #ff9900);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      transition: all 0.2s ease-in-out;
    }

    .avanti-btn {
      padding: 14px 20px;
      font-size: 18px;
      font-family: 'Arial', sans-serif;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, #3d33ff, #0040ff);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      transition: all 0.2s ease-in-out;
    }

    .cocktail-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.35);
      background: linear-gradient(135deg, #ffdd55, #ffbb00);
    }

    .cocktail-btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }

    select {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 200px;
    }

    select:focus {
      border-color: #007bff;
      outline: none;
    }
  </style>






</body>

</html>